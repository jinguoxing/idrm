# IDRM é¡¹ç›®æ¶æ„è¯´æ˜

> **ç‰ˆæœ¬**: v2.0  
> **æ›´æ–°æ—¶é—´**: 2025-12-22  
> **æ¶æ„ç±»å‹**: go-zero å•ä¸€ API å…¥å£ + æ¨¡å—åŒ–ç»„ç»‡

---

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [ç›®å½•ç»“æ„](#ç›®å½•ç»“æ„)
- [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)

---

## é¡¹ç›®æ¦‚è¿°

IDRM æ˜¯ä¸€ä¸ªåŸºäº **go-zero** æ¡†æ¶æ„å»ºçš„æ•°æ®èµ„æºç®¡ç†ç³»ç»Ÿï¼Œé‡‡ç”¨**æ¨¡å—åŒ–**æ¶æ„è®¾è®¡ï¼Œæä¾›ç»Ÿä¸€çš„ API æœåŠ¡å…¥å£ã€‚

### æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: go-zero v1.6.0
- **ORM**: åŒ ORM æ”¯æŒï¼ˆsqlx / gormï¼‰
- **æ•°æ®åº“**: MySQL
- **ç¼“å­˜**: Redisï¼ˆå¯é€‰ï¼‰
- **æ¶ˆæ¯é˜Ÿåˆ—**: Kafkaï¼ˆå¯é€‰ï¼‰

### è®¾è®¡ç†å¿µ

- âœ… å•ä¸€ API å…¥å£ï¼Œæ¨¡å—åŒ–ç»„ç»‡
- âœ… åŒ ORM æ”¯æŒï¼Œé…ç½®åˆ‡æ¢
- âœ… ç¬¦åˆ go-zero è§„èŒƒï¼Œgoctl å‹å¥½
- âœ… æ¸…æ™°çš„ä¸‰å±‚ç›®å½•ç»“æ„
- âœ… æ˜“äºæ‰©å±•å’Œç»´æŠ¤

---

## ç›®å½•ç»“æ„

### å®Œæ•´ç›®å½•æ ‘

```
idrm/
â”œâ”€â”€ api/                          # API æœåŠ¡ï¼ˆç»Ÿä¸€å…¥å£ï¼‰
â”‚   â”œâ”€â”€ api.go                    # æœåŠ¡å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ etc/
â”‚   â”‚   â””â”€â”€ api.yaml              # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ doc/                      # API å®šä¹‰æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ api.api               # ä¸»APIå®šä¹‰ï¼ˆå¯¼å…¥æ‰€æœ‰æ¨¡å—ï¼‰
â”‚   â”‚   â”œâ”€â”€ README.md             # ä½¿ç”¨è¯´æ˜
â”‚   â”‚   â”œâ”€â”€ STRUCTURE.md          # ç›®å½•ç»“æ„è¯¦è§£
â”‚   â”‚   â””â”€â”€ resource_catalog/     # èµ„æºç›®å½•æ¨¡å—
â”‚   â”‚       â””â”€â”€ category.api      # ç±»åˆ«åŠŸèƒ½API
â”‚   â”‚
â”‚   â””â”€â”€ internal/
â”‚       â”œâ”€â”€ config/               # é…ç½®ç»“æ„
â”‚       â”‚   â””â”€â”€ config.go
â”‚       â”œâ”€â”€ handler/              # HTTP å¤„ç†å™¨
â”‚       â”‚   â”œâ”€â”€ routes.go         # è·¯ç”±æ³¨å†Œï¼ˆgoctlç”Ÿæˆï¼‰
â”‚       â”‚   â””â”€â”€ resource_catalog/ # èµ„æºç›®å½•æ¨¡å—
â”‚       â”‚       â””â”€â”€ category/     # ç±»åˆ«åŠŸèƒ½
â”‚       â”‚           â”œâ”€â”€ getcategoryhandler.go
â”‚       â”‚           â”œâ”€â”€ createcategoryhandler.go
â”‚       â”‚           â””â”€â”€ listcategoryhandler.go
â”‚       â”‚
â”‚       â”œâ”€â”€ logic/                # ä¸šåŠ¡é€»è¾‘
â”‚       â”‚   â””â”€â”€ resource_catalog/
â”‚       â”‚       â””â”€â”€ category/
â”‚       â”‚           â”œâ”€â”€ getcategorylogic.go
â”‚       â”‚           â”œâ”€â”€ createcategorylogic.go
â”‚       â”‚           â””â”€â”€ listcategorylogic.go
â”‚       â”‚
â”‚       â”œâ”€â”€ middleware/           # ä¸­é—´ä»¶
â”‚       â”œâ”€â”€ svc/                  # æœåŠ¡ä¸Šä¸‹æ–‡
â”‚       â”‚   â””â”€â”€ servicecontext.go
â”‚       â””â”€â”€ types/                # ç±»å‹å®šä¹‰
â”‚           â””â”€â”€ types.go
â”‚
â”œâ”€â”€ model/                        # æ•°æ®æ¨¡å‹å±‚
â”‚   â””â”€â”€ resource_catalog/
â”‚       â”œâ”€â”€ interface.go          # æ¨¡å‹æ¥å£å®šä¹‰
â”‚       â”œâ”€â”€ types.go              # å®ä½“ç±»å‹å®šä¹‰
â”‚       â”œâ”€â”€ vars.go               # å¸¸é‡å’Œé”™è¯¯å®šä¹‰
â”‚       â”œâ”€â”€ sqlx/                 # sqlx å®ç°
â”‚       â”‚   â””â”€â”€ categorymodel.go
â”‚       â””â”€â”€ gorm/                 # gorm å®ç°
â”‚           â””â”€â”€ categorymodel.go
â”‚
â”œâ”€â”€ pkg/                          # å…¬å…±åŒ…
â”‚   â”œâ”€â”€ config/                   # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ errorx/                   # é”™è¯¯å¤„ç†
â”‚   â”œâ”€â”€ middleware/               # å…¬å…±ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ response/                 # ç»Ÿä¸€å“åº”
â”‚   â”œâ”€â”€ utils/                    # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ logger/                   # æ—¥å¿—å°è£…
â”‚
â”œâ”€â”€ consumer/                     # æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…ï¼ˆé¢„ç•™ï¼‰
â”‚   â””â”€â”€ README.md
â”‚
â”œâ”€â”€ job/                          # å®šæ—¶ä»»åŠ¡ï¼ˆé¢„ç•™ï¼‰
â”‚   â””â”€â”€ README.md
â”‚
â”œâ”€â”€ rpc/                          # gRPC æœåŠ¡ï¼ˆé¢„ç•™ï¼‰
â”‚   â””â”€â”€ README.md
â”‚
â”œâ”€â”€ docs/                         # é¡¹ç›®æ–‡æ¡£
â”‚   â””â”€â”€ architecture/
â”‚
â”œâ”€â”€ deploy/                       # éƒ¨ç½²é…ç½®
â”œâ”€â”€ migrations/                   # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ scripts/                      # è„šæœ¬å·¥å…·
â”œâ”€â”€ test/                         # æµ‹è¯•
â”‚
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ Makefile
â””â”€â”€ README.md
```

### ç›®å½•è¯´æ˜

#### `api/` - API æœåŠ¡

**å•ä¸€ API å…¥å£**ï¼Œæ‰€æœ‰ä¸šåŠ¡æ¨¡å—é€šè¿‡æ¨¡å—åŒ–ç»„ç»‡åœ¨ä¸€ä¸ªæœåŠ¡ä¸­ã€‚

- **`api.go`**: æœåŠ¡å¯åŠ¨å…¥å£
- **`doc/`**: API å®šä¹‰æ–‡ä»¶ï¼ˆ.api æ ¼å¼ï¼‰
  - æŒ‰æ¨¡å—åˆ’åˆ†å­ç›®å½•
  - ä¸»æ–‡ä»¶é€šè¿‡ import å¯¼å…¥å„æ¨¡å—
- **`internal/`**: å†…éƒ¨å®ç°
  - **`handler/`**: HTTP å¤„ç†å™¨ï¼ˆä¸‰å±‚ç›®å½•ï¼šæ¨¡å—/åŠŸèƒ½/æ“ä½œï¼‰
  - **`logic/`**: ä¸šåŠ¡é€»è¾‘ï¼ˆä¸‰å±‚ç›®å½•ï¼šæ¨¡å—/åŠŸèƒ½/æ“ä½œï¼‰
  - **`types/`**: è¯·æ±‚/å“åº”ç±»å‹å®šä¹‰
  - **`svc/`**: æœåŠ¡ä¸Šä¸‹æ–‡ï¼ˆä¾èµ–æ³¨å…¥ï¼‰

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… ä¸éœ€è¦æ¨¡å—çº§çš„ `routes.go`ï¼Œåªæœ‰é¡¶å±‚ç»Ÿä¸€è·¯ç”±
- âœ… Handler å’Œ Logic æŒ‰ `æ¨¡å—/åŠŸèƒ½/æ“ä½œ` ä¸‰å±‚ç»„ç»‡
- âœ… ä½¿ç”¨ `goctl api go -api doc/api.api -dir .` ç”Ÿæˆä»£ç 

#### `model/` - æ•°æ®æ¨¡å‹å±‚

**åŒ ORM æ”¯æŒ**ï¼Œé€šè¿‡æ¥å£æŠ½è±¡å®ç° sqlx å’Œ gorm çš„ç»Ÿä¸€ã€‚

```go
// interface.go - å®šä¹‰æ¥å£
type CategoryModel interface {
    FindOne(ctx context.Context, id int64) (*Category, error)
    Insert(ctx context.Context, data *Category) error
    // ...
}

// sqlx/categorymodel.go - sqlx å®ç°
func NewCategoryModel(conn sqlx.SqlConn) CategoryModel {
    return &defaultCategoryModel{conn: conn}
}

// gorm/categorymodel.go - gorm å®ç°
func NewCategoryModel(db *gorm.DB) CategoryModel {
    return &defaultCategoryModel{db: db}
}
```

**é…ç½®åˆ‡æ¢**ï¼š
```yaml
# api/etc/api.yaml
ORM: sqlx  # æˆ– gorm
```

#### `pkg/` - å…¬å…±åŒ…

é¡¹ç›®çº§å…¬å…±ä»£ç ï¼Œå¯è¢«æ‰€æœ‰æœåŠ¡å¤ç”¨ã€‚

- **`errorx/`**: ç»Ÿä¸€é”™è¯¯ç å’Œé”™è¯¯å¤„ç†
- **`config/`**: é…ç½®æ–‡ä»¶ç®¡ç†
- **`middleware/`**: å…¬å…±ä¸­é—´ä»¶ï¼ˆè®¤è¯ã€CORS ç­‰ï¼‰
- **`response/`**: ç»Ÿä¸€å“åº”æ ¼å¼
- **`utils/`**: å·¥å…·å‡½æ•°
- **`logger/`**: æ—¥å¿—å°è£…

#### `consumer/`, `job/`, `rpc/` - é¢„ç•™ç›®å½•

ç”¨äºæœªæ¥æ‰©å±•ï¼š
- **`consumer/`**: Kafka ç­‰æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…
- **`job/`**: å®šæ—¶ä»»åŠ¡ï¼ˆcronï¼‰
- **`rpc/`**: gRPC æœåŠ¡

æ¯ä¸ªç›®å½•åŒ…å« README.md è¯´æ˜æ–‡æ¡£ã€‚

---

## æ ¸å¿ƒç‰¹æ€§

### 1. ç»Ÿä¸€ API å…¥å£

æ‰€æœ‰ä¸šåŠ¡æ¨¡å—åœ¨ä¸€ä¸ª API æœåŠ¡ä¸­ï¼Œé¿å…å¾®æœåŠ¡è¿‡æ—©æ‹†åˆ†çš„å¤æ‚æ€§ã€‚

**æ¨¡å—ç»„ç»‡**ï¼š
- `handler/resource_catalog/category/` - èµ„æºç›®å½•-ç±»åˆ«
- `handler/resource_catalog/directory/` - èµ„æºç›®å½•-ç›®å½•
- `handler/data_view/query/` - æ•°æ®è§†å›¾-æŸ¥è¯¢

**è·¯ç”±ç¤ºä¾‹**ï¼š
```
GET  /api/v1/catalog/categories/:id     # è·å–ç±»åˆ«
POST /api/v1/catalog/categories         # åˆ›å»ºç±»åˆ«
GET  /api/v1/catalog/categories         # ç±»åˆ«åˆ—è¡¨
```

### 2. æ¨¡å—åŒ– API å®šä¹‰

API å®šä¹‰æ–‡ä»¶æŒ‰æ¨¡å—ç»„ç»‡ï¼Œä¸»æ–‡ä»¶é€šè¿‡ import å¯¼å…¥ã€‚

```
doc/
â”œâ”€â”€ api.api                      # ä¸»æ–‡ä»¶
â””â”€â”€ resource_catalog/
    â”œâ”€â”€ category.api             # ç±»åˆ«API
    â””â”€â”€ directory.api            # ç›®å½•API
```

**ä¸»æ–‡ä»¶ç¤ºä¾‹**ï¼š
```api
syntax = "v1"

import "resource_catalog/category.api"
import "resource_catalog/directory.api"
```

**æ¨¡å—æ–‡ä»¶ç¤ºä¾‹**ï¼š
```api
syntax = "v1"

@server(
    group: resource_catalog/category  // ç”Ÿæˆä¸‰å±‚ç›®å½•
    prefix: /api/v1/catalog
)
service Api {
    @doc "è·å–ç±»åˆ«è¯¦æƒ…"
    @handler GetCategory
    get /categories/:id (CategoryReq) returns (CategoryResp)
}
```

### 3. åŒ ORM æ”¯æŒ

é€šè¿‡æ¥å£æŠ½è±¡ï¼Œæ”¯æŒ sqlx å’Œ gorm ä¸¤ç§ ORMï¼Œé…ç½®æ–‡ä»¶æ§åˆ¶ä½¿ç”¨å“ªç§å®ç°ã€‚

**ä¼˜åŠ¿**ï¼š
- âœ… ä¸šåŠ¡ä»£ç æ— éœ€ä¿®æ”¹
- âœ… å¯æ ¹æ®åœºæ™¯é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆ
- âœ… sqlx: æ€§èƒ½é«˜ï¼Œé€‚åˆç®€å•æŸ¥è¯¢
- âœ… gorm: åŠŸèƒ½å¼ºï¼Œé€‚åˆå¤æ‚æŸ¥è¯¢

### 4. ä¸‰å±‚ç›®å½•ç»“æ„

Handler å’Œ Logic é‡‡ç”¨ä¸‰å±‚ç»„ç»‡ï¼š

```
ç¬¬ä¸€å±‚: ä¸šåŠ¡æ¨¡å—ï¼ˆresource_catalogï¼‰
ç¬¬äºŒå±‚: åŠŸèƒ½ç‚¹ï¼ˆcategory, directoryï¼‰
ç¬¬ä¸‰å±‚: CRUDæ“ä½œï¼ˆget, create, list, update, deleteï¼‰
```

**ç¤ºä¾‹**ï¼š
```
handler/resource_catalog/
â”œâ”€â”€ category/
â”‚   â”œâ”€â”€ getcategoryhandler.go
â”‚   â”œâ”€â”€ createcategoryhandler.go
â”‚   â””â”€â”€ listcategoryhandler.go
â””â”€â”€ directory/
    â”œâ”€â”€ getdirectoryhandler.go
    â””â”€â”€ createdirectoryhandler.go
```

---

## å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨ API æœåŠ¡

```bash
cd api
go run api.go -f etc/api.yaml
```

æœåŠ¡å°†åœ¨ `http://localhost:8888` å¯åŠ¨ã€‚

### 2. é…ç½®æ•°æ®åº“

ç¼–è¾‘ `api/etc/api.yaml`ï¼š

```yaml
Name: idrm-api
Host: 0.0.0.0
Port: 8888

# æ•°æ®åº“é…ç½®
DataSource: root:password@tcp(localhost:3306)/idrm?charset=utf8mb4&parseTime=true

# ORM é€‰æ‹©: sqlx æˆ– gorm
ORM: sqlx
```

### 3. ç”Ÿæˆä»£ç 

å½“ä¿®æ”¹ API å®šä¹‰åï¼Œé‡æ–°ç”Ÿæˆä»£ç ï¼š

```bash
cd api
goctl api go -api doc/api.api -dir .
```

---

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°åŠŸèƒ½

**åœºæ™¯**: åœ¨èµ„æºç›®å½•æ¨¡å—ä¸‹æ·»åŠ  "æ ‡ç­¾(Tag)" åŠŸèƒ½

#### æ­¥éª¤ 1: åˆ›å»º API å®šä¹‰

åˆ›å»º `api/doc/resource_catalog/tag.api`ï¼š

```api
syntax = "v1"

type (
    TagReq {
        Id int64 `path:"id"`
    }
    
    TagResp {
        Id   int64  `json:"id"`
        Name string `json:"name"`
    }
)

@server(
    group: resource_catalog/tag
    prefix: /api/v1/catalog
)
service Api {
    @doc "è·å–æ ‡ç­¾"
    @handler GetTag
    get /tags/:id (TagReq) returns (TagResp)
}
```

#### æ­¥éª¤ 2: å¯¼å…¥åˆ°ä¸»æ–‡ä»¶

ç¼–è¾‘ `api/doc/api.api`ï¼š

```api
import "resource_catalog/category.api"
import "resource_catalog/tag.api"  // æ–°å¢
```

#### æ­¥éª¤ 3: ç”Ÿæˆä»£ç 

```bash
cd api
goctl api go -api doc/api.api -dir .
```

è‡ªåŠ¨ç”Ÿæˆï¼š
```
handler/resource_catalog/tag/
â””â”€â”€ gettaghandler.go

logic/resource_catalog/tag/
â””â”€â”€ gettaglogic.go
```

#### æ­¥éª¤ 4: å®ç°ä¸šåŠ¡é€»è¾‘

ç¼–è¾‘ `logic/resource_catalog/tag/gettaglogic.go`ï¼š

```go
func (l *GetTagLogic) GetTag(req *types.TagReq) (resp *types.TagResp, err error) {
    tag, err := l.svcCtx.TagModel.FindOne(l.ctx, req.Id)
    if err != nil {
        return nil, errorx.NewWithMsg(404, "æ ‡ç­¾ä¸å­˜åœ¨")
    }
    
    return &types.TagResp{
        Id:   tag.Id,
        Name: tag.Name,
    }, nil
}
```

### æ·»åŠ  Model å±‚

#### æ­¥éª¤ 1: åˆ›å»ºæ¥å£å®šä¹‰

`model/resource_catalog/tagmodel.go`:

```go
package resource_catalog

type Tag struct {
    Id   int64  `db:"id" gorm:"column:id"`
    Name string `db:"name" gorm:"column:name"`
}

type TagModel interface {
    FindOne(ctx context.Context, id int64) (*Tag, error)
    Insert(ctx context.Context, data *Tag) error
}
```

#### æ­¥éª¤ 2: å®ç° sqlx ç‰ˆæœ¬

`model/resource_catalog/sqlx/tagmodel.go`:

```go
type defaultTagModel struct {
    conn sqlx.SqlConn
}

func NewTagModel(conn sqlx.SqlConn) resource_catalog.TagModel {
    return &defaultTagModel{conn: conn}
}

func (m *defaultTagModel) FindOne(ctx context.Context, id int64) (*resource_catalog.Tag, error) {
    var tag resource_catalog.Tag
    query := "SELECT * FROM tags WHERE id = ?"
    err := m.conn.QueryRowCtx(ctx, &tag, query, id)
    return &tag, err
}
```

#### æ­¥éª¤ 3: å®ç° gorm ç‰ˆæœ¬

`model/resource_catalog/gorm/tagmodel.go`:

```go
type defaultTagModel struct {
    db *gorm.DB
}

func NewTagModel(db *gorm.DB) resource_catalog.TagModel {
    return &defaultTagModel{db: db}
}

func (m *defaultTagModel) FindOne(ctx context.Context, id int64) (*resource_catalog.Tag, error) {
    var tag resource_catalog.Tag
    err := m.db.WithContext(ctx).Where("id = ?", id).First(&tag).Error
    return &tag, err
}
```

#### æ­¥éª¤ 4: æ³¨å†Œåˆ° ServiceContext

ç¼–è¾‘ `api/internal/svc/servicecontext.go`:

```go
type ServiceContext struct {
    Config        config.Config
    CategoryModel resource_catalog.CategoryModel
    TagModel      resource_catalog.TagModel  // æ–°å¢
}

func NewServiceContext(c config.Config) *ServiceContext {
    // ... åˆå§‹åŒ–é€»è¾‘
}
```

### åˆ‡æ¢ ORM

ç¼–è¾‘ `api/etc/api.yaml`ï¼š

```yaml
# ä½¿ç”¨ sqlx
ORM: sqlx

# æˆ–ä½¿ç”¨ gorm
ORM: gorm
```

ä¿®æ”¹ `api/internal/svc/servicecontext.go` ä¸­çš„åˆå§‹åŒ–é€»è¾‘ï¼š

```go
func NewServiceContext(c config.Config) *ServiceContext {
    if c.ORM == "gorm" {
        db := initGorm(c.DataSource)
        return &ServiceContext{
            Config:        c,
            CategoryModel: gorm.NewCategoryModel(db),
            TagModel:      gorm.NewTagModel(db),
        }
    }
    
    // é»˜è®¤ä½¿ç”¨ sqlx
    conn := initSqlx(c.DataSource)
    return &ServiceContext{
        Config:        c,
        CategoryModel: sqlx.NewCategoryModel(conn),
        TagModel:      sqlx.NewTagModel(conn),
    }
}
```

---

## æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     HTTP / gRPC / MQ            â”‚  â† å…¥å£å±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Handler (resource_catalog)     â”‚  â† å¤„ç†å™¨å±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Logic (resource_catalog)       â”‚  â† ä¸šåŠ¡é€»è¾‘å±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Model Interface                â”‚  â† æ¥å£å±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  sqlx / gorm Implementation     â”‚  â† å®ç°å±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Database / Cache / MQ          â”‚  â† å­˜å‚¨å±‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¾èµ–å…³ç³»

- **Handler** ä¾èµ– â†’ Logic
- **Logic** ä¾èµ– â†’ Model Interface
- **Model Interface** è¢« â†’ sqlx/gorm å®ç°
- **pkg** å¯è¢«æ‰€æœ‰å±‚ä½¿ç”¨

**åŸåˆ™**ï¼š
- âœ… å•å‘ä¾èµ–ï¼Œä¸Šå±‚ä¾èµ–ä¸‹å±‚
- âœ… æ¥å£éš”ç¦»ï¼Œä¾èµ–æ¥å£è€Œéå®ç°
- âœ… é€šè¿‡ ServiceContext æ³¨å…¥ä¾èµ–

### æ¨¡å—åˆ’åˆ†

å½“å‰æ¨¡å—ï¼š
- **resource_catalog**: èµ„æºç›®å½•ç®¡ç†
  - `category`: ç±»åˆ«ç®¡ç†
  - `directory`: ç›®å½•ç®¡ç†ï¼ˆå¾…å¼€å‘ï¼‰
  - `tag`: æ ‡ç­¾ç®¡ç†ï¼ˆå¾…å¼€å‘ï¼‰

æœªæ¥æ¨¡å—ï¼š
- **data_view**: æ•°æ®è§†å›¾
- **data_understanding**: æ•°æ®ç†è§£

### æ‰©å±•æ€§è®¾è®¡

#### æ°´å¹³æ‰©å±•
- API æœåŠ¡å¯å¤šå®ä¾‹éƒ¨ç½²
- æ— çŠ¶æ€è®¾è®¡ï¼Œè´Ÿè½½å‡è¡¡å‹å¥½

#### å‚ç›´æ‰©å±•
- æœªæ¥å¯æ‹†åˆ†ä¸ºç‹¬ç«‹æœåŠ¡ï¼š
  - `consumer/` â†’ ç‹¬ç«‹æ¶ˆè´¹è€…æœåŠ¡
  - `job/` â†’ ç‹¬ç«‹å®šæ—¶ä»»åŠ¡æœåŠ¡
  - `rpc/` â†’ ç‹¬ç«‹ gRPC æœåŠ¡

#### æ’ä»¶åŒ–
- é€šè¿‡ `pkg/` æä¾›å…¬å…±èƒ½åŠ›
- Model å±‚æ”¯æŒå¤šç§ ORM
- ä¸­é—´ä»¶å¯æ’æ‹”

---

## æœ€ä½³å®è·µ

### 1. API å®šä¹‰è§„èŒƒ

- âœ… ä½¿ç”¨æœ‰æ„ä¹‰çš„ handler åç§°ï¼ˆå¦‚ `GetCategory`ï¼‰
- âœ… RESTful é£æ ¼çš„è·¯ç”±ï¼ˆ`/categories/:id`ï¼‰
- âœ… åˆç†ä½¿ç”¨ pathã€queryã€formã€json å‚æ•°
- âœ… æ·»åŠ  `@doc` æ³¨é‡Šè¯´æ˜æ¥å£ç”¨é€”

### 2. é”™è¯¯å¤„ç†

ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯ç ï¼š

```go
import "idrm/pkg/errorx"

// ä½¿ç”¨é¢„å®šä¹‰é”™è¯¯ç 
return nil, errorx.NewWithCode(errorx.ErrCodeNotFound)

// æˆ–è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯
return nil, errorx.NewWithMsg(404, "ç±»åˆ«ä¸å­˜åœ¨")
```

### 3. æ—¥å¿—è®°å½•

ä½¿ç”¨ go-zero å†…ç½®çš„ logxï¼š

```go
logx.WithContext(l.ctx).Infof("Finding category: %d", req.Id)
logx.WithContext(l.ctx).Errorf("Database error: %v", err)
```

### 4. é…ç½®ç®¡ç†

- âœ… æ•æ„Ÿä¿¡æ¯ä½¿ç”¨ç¯å¢ƒå˜é‡
- âœ… é…ç½®æ–‡ä»¶åˆ†ç¯å¢ƒï¼ˆdev/test/prodï¼‰
- âœ… ä½¿ç”¨ go-zero çš„é…ç½®è‡ªåŠ¨åŠ è½½

### 5. æµ‹è¯•

```go
// logic å±‚å•å…ƒæµ‹è¯•
func TestGetCategoryLogic(t *testing.T) {
    // Mock ServiceContext
    // æµ‹è¯•ä¸šåŠ¡é€»è¾‘
}

// API é›†æˆæµ‹è¯•
func TestCategoryAPI(t *testing.T) {
    // æµ‹è¯•å®Œæ•´çš„ HTTP è°ƒç”¨
}
```

---

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆä¸éœ€è¦æ¨¡å—çº§çš„ routes.goï¼Ÿ

A: go-zero çš„ goctl å·¥å…·ä¼šè‡ªåŠ¨åœ¨é¡¶å±‚ç”Ÿæˆç»Ÿä¸€çš„ `routes.go`ï¼Œé€šè¿‡ `group` å­—æ®µè‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”çš„ handlerã€‚æ¨¡å—çº§ routes.go æ˜¯å¤šä½™çš„ã€‚

### Q: å¦‚ä½•é€‰æ‹© sqlx è¿˜æ˜¯ gormï¼Ÿ

A:
- **sqlx**: æ€§èƒ½é«˜ï¼ŒSQL å¯æ§ï¼Œé€‚åˆç®€å•æŸ¥è¯¢å’Œé«˜æ€§èƒ½åœºæ™¯
- **gorm**: åŠŸèƒ½å¼ºï¼Œå¼€å‘æ•ˆç‡é«˜ï¼Œé€‚åˆå¤æ‚æŸ¥è¯¢å’Œå¿«é€Ÿå¼€å‘

é€šè¿‡é…ç½®æ–‡ä»¶å¯éšæ—¶åˆ‡æ¢ï¼Œå»ºè®®ï¼š
- ç”Ÿäº§ç¯å¢ƒï¼šsqlxï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
- å¼€å‘ç¯å¢ƒï¼šgormï¼ˆæ•ˆç‡ä¼˜å…ˆï¼‰

### Q: ä¸‰å±‚ç›®å½•ä¼šä¸ä¼šå¤ªæ·±ï¼Ÿ

A: ä¸‰å±‚ç›®å½•ï¼ˆæ¨¡å—/åŠŸèƒ½/æ“ä½œï¼‰çš„ä¼˜åŠ¿ï¼š
- âœ… é¿å…æ–‡ä»¶è¿‡å¤šå¯¼è‡´æ··ä¹±
- âœ… æŒ‰åŠŸèƒ½ç‚¹æ¸…æ™°ç»„ç»‡
- âœ… æ˜“äºæŸ¥æ‰¾å’Œç»´æŠ¤
- âœ… æ”¯æŒå¤§å‹é¡¹ç›®æ‰©å±•

### Q: consumerã€jobã€rpc ç›®å½•ä¸ºä»€ä¹ˆæ˜¯ç©ºçš„ï¼Ÿ

A: è¿™äº›æ˜¯é¢„ç•™ç›®å½•ï¼Œç”¨äºæœªæ¥æ‰©å±•ï¼š
- å½“éœ€è¦å¼‚æ­¥å¤„ç†æ—¶ï¼Œåœ¨ `consumer/` ä¸­æ·»åŠ æ¶ˆè´¹è€…
- å½“éœ€è¦å®šæ—¶ä»»åŠ¡æ—¶ï¼Œåœ¨ `job/` ä¸­æ·»åŠ ä»»åŠ¡
- å½“éœ€è¦å†…éƒ¨ RPC è°ƒç”¨æ—¶ï¼Œåœ¨ `rpc/` ä¸­æ·»åŠ æœåŠ¡

æ¯ä¸ªç›®å½•éƒ½åŒ…å« README.md è¯´æ˜å¦‚ä½•ä½¿ç”¨ã€‚

---

## å‚è€ƒæ–‡æ¡£

- [go-zero å®˜æ–¹æ–‡æ¡£](https://go-zero.dev/)
- [goctl ä½¿ç”¨æŒ‡å—](https://go-zero.dev/docs/tutorials/cli/overview)
- [API å®šä¹‰è¯­æ³•](https://go-zero.dev/docs/tutorials/api/route)
- [é¡¹ç›®å†…æ–‡æ¡£](api/doc/README.md)
- [ç›®å½•ç»“æ„è¯¦è§£](api/doc/STRUCTURE.md)

---

## æ›´æ–°æ—¥å¿—

### v2.0 (2025-12-22)
- âœ… é‡‡ç”¨ go-zero å•ä¸€ API å…¥å£æ¶æ„
- âœ… å®ç°åŒ ORM æ”¯æŒï¼ˆsqlx/gormï¼‰
- âœ… ä¸‰å±‚ç›®å½•ç»“æ„ï¼ˆæ¨¡å—/åŠŸèƒ½/æ“ä½œï¼‰
- âœ… æ¨¡å—åŒ– API å®šä¹‰æ–‡ä»¶
- âœ… åˆ é™¤æ—§æ¶æ„ç›®å½•ï¼ˆcmd/app/domain/infrastructureï¼‰
- âœ… é¢„ç•™æ‰©å±•ç›®å½•ï¼ˆconsumer/job/rpcï¼‰

### v1.0 (å†å²ç‰ˆæœ¬)
- æ—§çš„åˆ†å±‚æ¶æ„ï¼ˆå·²åºŸå¼ƒï¼‰
- è¯¦è§ `docs/architecture/*.bak` å¤‡ä»½æ–‡ä»¶
