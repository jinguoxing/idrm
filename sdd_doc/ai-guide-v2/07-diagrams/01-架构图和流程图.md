# 架构图和流程图

> 可视化理解IDRM AI编程体系

---

## 🏗️ 整体架构图

### IDRM AI编程体系架构

```mermaid
graph TB
    subgraph "Spec v2.0 规范体系"
        A1[核心规范 core/]
        A2[架构规范 architecture/]
        A3[编码规范 coding-standards/]
        A4[工作流 workflow/]
        A5[质量保证 quality/]
        A6[治理机制 governance/]
    end
    
    subgraph "5阶段工作流"
        B1[Phase 0: Context]
        B2[Phase 1: Specify]
        B3[Phase 2: Design]
        B4[Phase 3: Tasks]
        B5[Phase 4: Implement]
        
        B1 --> B2
        B2 --> B3
        B3 --> B4
        B4 --> B5
    end
    
    subgraph "AI工具生态"
        C1[Kiro.dev<br/>结构化开发]
        C2[Cursor<br/>快速编码]
        C3[Claude CLI<br/>自动化]
    end
    
    subgraph "质量保障"
        D1[Gate 1: Specify]
        D2[Gate 2: Design]
        D3[Gate 3: Tasks]
        D4[Gate 4: Implement]
    end
    
    A1 --> B1
    A2 --> B3
    A3 --> B5
    A4 --> B1
    A5 --> D1
    
    B2 --> D1
    B3 --> D2
    B4 --> D3
    B5 --> D4
    
    C1 -.支持.-> B2
    C1 -.支持.-> B3
    C1 -.支持.-> B4
    C2 -.支持.-> B5
    C3 -.支持.-> D4
    
    D4 --> E[高质量代码]
    
    style A1 fill:#e1f5ff
    style B1 fill:#fff4e1
    style C1 fill:#e8f5e9
    style D1 fill:#fce4ec
    style E fill:#f3e5f5
```

---

## 🔄 5阶段工作流详细流程

### 完整开发流程

```mermaid
flowchart TD
    Start([开始新功能]) --> P0{Phase 0: Context}
    
    P0 --> P0_1[阅读核心规范]
    P0_1 --> P0_2[理解架构规范]
    P0_2 --> P0_3[准备开发环境]
    P0_3 --> P0_Check{环境就绪?}
    P0_Check -->|否| P0_1
    P0_Check -->|是| P1
    
    P1[Phase 1: Specify] --> P1_1[编写用户故事]
    P1_1 --> P1_2[定义验收标准<br/>EARS格式]
    P1_2 --> P1_3[明确业务规则]
    P1_3 --> P1_4[定义数据考量]
    P1_4 --> G1{Gate 1检查}
    G1 -->|不通过| P1_1
    G1 -->|通过| P2
    
    P2[Phase 2: Design] --> P2_1[架构设计]
    P2_1 --> P2_2[文件结构规划]
    P2_2 --> P2_3[接口定义]
    P2_3 --> P2_4[序列图设计]
    P2_4 --> G2{Gate 2检查}
    G2 -->|不通过| P2_1
    G2 -->|通过| P3
    
    P3[Phase 3: Tasks] --> P3_1[任务拆分<br/>每个<50行]
    P3_1 --> P3_2[定义依赖关系]
    P3_2 --> P3_3[明确验收标准]
    P3_3 --> G3{Gate 3检查}
    G3 -->|不通过| P3_1
    G3 -->|通过| P4
    
    P4[Phase 4: Implement] --> P4_1[逐个实施Task]
    P4_1 --> P4_2[编写测试]
    P4_2 --> P4_3[Self Review]
    P4_3 --> P4_4[运行测试]
    P4_4 --> G4{Gate 4检查}
    G4 -->|编译失败| P4_1
    G4 -->|测试失败| P4_2
    G4 -->|Lint失败| P4_1
    G4 -->|全部通过| P4_5[Peer Review]
    P4_5 --> P4_6{Review通过?}
    P4_6 -->|否| P4_1
    P4_6 -->|是| End([功能完成])
    
    style P0 fill:#e3f2fd
    style P1 fill:#fff3e0
    style P2 fill:#e8f5e9
    style P3 fill:#fce4ec
    style P4 fill:#f3e5f5
    style G1 fill:#ffebee
    style G2 fill:#ffebee
    style G3 fill:#ffebee
    style G4 fill:#ffebee
    style End fill:#c8e6c9
```

---

## 🏛️ 分层架构详图

### Handler → Logic → Model

```mermaid
graph LR
    subgraph "外部请求"
        A[HTTP Request]
    end
    
    subgraph "Handler层"
        B1[参数解析]
        B2[参数验证]
        B3[调用Logic]
        B4[响应封装]
        
        B1 --> B2
        B2 --> B3
        B3 --> B4
    end
    
    subgraph "Logic层"
        C1[业务逻辑]
        C2[数据转换]
        C3[调用Model]
        C4[结果处理]
        
        C1 --> C2
        C2 --> C3
        C3 --> C4
    end
    
    subgraph "Model层"
        D1{ORM选择}
        D2[GORM<br/>复杂查询]
        D3[SQLx<br/>简单CRUD]
        D4[数据库操作]
        
        D1 -->|复杂| D2
        D1 -->|简单| D3
        D2 --> D4
        D3 --> D4
    end
    
    subgraph "数据库"
        E[(MySQL)]
    end
    
    A --> B1
    B4 --> F[HTTP Response]
    B3 --> C1
    C4 --> B3
    C3 --> D1
    D4 --> E
    
    style B1 fill:#e3f2fd
    style C1 fill:#fff3e0
    style D1 fill:#e8f5e9
    style E fill:#fce4ec
```

### 数据流向

```mermaid
sequenceDiagram
    participant Client
    participant Handler
    participant Logic
    participant Model
    participant DB
    
    Client->>Handler: HTTP Request
    activate Handler
    Handler->>Handler: 解析参数
    Handler->>Handler: 验证参数
    
    Handler->>Logic: 调用业务方法
    activate Logic
    Logic->>Logic: 业务逻辑处理
    Logic->>Logic: 数据转换
    
    Logic->>Model: CRUD操作
    activate Model
    Model->>Model: ORM选择
    Model->>DB: SQL执行
    activate DB
    DB-->>Model: 返回结果
    deactivate DB
    Model-->>Logic: 返回数据
    deactivate Model
    
    Logic->>Logic: 结果处理
    Logic-->>Handler: 返回业务数据
    deactivate Logic
    
    Handler->>Handler: 响应封装
    Handler-->>Client: HTTP Response
    deactivate Handler
```

---

## 🛠️ AI工具协作流程

### 三工具协同开发

```mermaid
flowchart LR
    subgraph "Kiro.dev - 规划阶段"
        K1[创建Spec]
        K2[生成Requirements]
        K3[生成Design]
        K4[生成Tasks]
        
        K1 --> K2
        K2 --> K3
        K3 --> K4
    end
    
    subgraph "Cursor - 开发阶段"
        C1[读取Tasks]
        C2[编写代码]
        C3[编写测试]
        C4[Self Review]
        
        C1 --> C2
        C2 --> C3
        C3 --> C4
    end
    
    subgraph "Claude CLI - 质检阶段"
        L1[批量Review]
        L2[生成测试]
        L3[质量报告]
        
        L1 --> L2
        L2 --> L3
    end
    
    K4 -->|导出specs| C1
    C4 -->|提交PR| L1
    L3 -->|发现问题| C2
    
    L3 --> Done[合并代码]
    
    style K1 fill:#e8f5e9
    style C1 fill:#e3f2fd
    style L1 fill:#fff3e0
    style Done fill:#c8e6c9
```

### 工具选择决策流程

```mermaid
flowchart TD
    Start([新需求]) --> Q1{功能复杂度?}
    
    Q1 -->|简单<100行| Simple
    Q1 -->|中等100-500行| Medium
    Q1 -->|复杂>500行| Complex
    
    Simple --> Q2{团队规模?}
    Q2 -->|1人| Cursor1[Cursor单打]
    Q2 -->|多人| Cursor2[Cursor + Claude Review]
    
    Medium --> Q3{需要规范?}
    Q3 -->|是| KiroCursor[Kiro规划 + Cursor开发]
    Q3 -->|否| CursorClaude[Cursor开发 + Claude Review]
    
    Complex --> All[Kiro + Cursor + Claude<br/>三工具联合]
    
    Cursor1 --> End([开始开发])
    Cursor2 --> End
    KiroCursor --> End
    CursorClaude --> End
    All --> End
    
    style Start fill:#e3f2fd
    style Cursor1 fill:#c8e6c9
    style Cursor2 fill:#c8e6c9
    style KiroCursor fill:#fff9c4
    style CursorClaude fill:#fff9c4
    style All fill:#ffccbc
    style End fill:#c8e6c9
```

---

## ✅ 质量门禁流程

### 4个Gate详细检查

```mermaid
flowchart TD
    subgraph "Gate 1: Specify检查"
        G1_1{用户故事完整?}
        G1_2{EARS格式正确?}
        G1_3{业务规则明确?}
        G1_4{数据考量清晰?}
        
        G1_1 -->|是| G1_2
        G1_2 -->|是| G1_3
        G1_3 -->|是| G1_4
    end
    
    subgraph "Gate 2: Design检查"
        G2_1{符合分层架构?}
        G2_2{文件清单完整?}
        G2_3{接口定义清晰?}
        G2_4{序列图完整?}
        
        G2_1 -->|是| G2_2
        G2_2 -->|是| G2_3
        G2_3 -->|是| G2_4
    end
    
    subgraph "Gate 3: Tasks检查"
        G3_1{每个task<50行?}
        G3_2{依赖关系清晰?}
        G3_3{验收标准明确?}
        
        G3_1 -->|是| G3_2
        G3_2 -->|是| G3_3
    end
    
    subgraph "Gate 4: Implement检查"
        G4_1[go build ./...]
        G4_2[go test -cover]
        G4_3[golangci-lint run]
        G4_4[Code Review]
        
        G4_1 -->|通过| G4_2
        G4_2 -->|>80%| G4_3
        G4_3 -->|无错误| G4_4
    end
    
    Start([开始]) --> G1_1
    G1_4 -->|通过| G2_1
    G2_4 -->|通过| G3_1
    G3_3 -->|通过| G4_1
    G4_4 -->|通过| End([发布])
    
    G1_1 -->|否| Fail1[返回修改]
    G2_1 -->|否| Fail2[返回修改]
    G3_1 -->|否| Fail3[返回修改]
    G4_1 -->|失败| Fail4[修复代码]
    
    style G1_1 fill:#ffebee
    style G2_1 fill:#fff3e0
    style G3_1 fill:#e8f5e9
    style G4_1 fill:#e3f2fd
    style End fill:#c8e6c9
    style Fail1 fill:#ffcdd2
    style Fail2 fill:#ffcdd2
    style Fail3 fill:#ffcdd2
    style Fail4 fill:#ffcdd2
```

---

## 🚀 典型场景流程图

### 场景：新增API接口

```mermaid
flowchart TD
    Start([需求：添加API]) --> Step1[Phase 1: Specify]
    
    Step1 --> S1_1[定义接口路径<br/>GET /api/v1/xxx]
    S1_1 --> S1_2[EARS验收标准]
    S1_2 --> S1_3[数据结构定义]
    S1_3 --> Check1{Gate 1}
    Check1 -->|通过| Step2[Phase 2: Design]
    Check1 -->|不通过| Step1
    
    Step2 --> S2_1[Handler设计<br/>xxxhandler.go]
    S2_1 --> S2_2[Logic设计<br/>xxxlogic.go]
    S2_2 --> S2_3[Model接口]
    S2_3 --> Check2{Gate 2}
    Check2 -->|通过| Step3[Phase 3: Tasks]
    Check2 -->|不通过| Step2
    
    Step3 --> S3_1[Task 1: Handler]
    S3_1 --> S3_2[Task 2: Logic]
    S3_2 --> S3_3[Task 3: 测试]
    S3_3 --> Check3{Gate 3}
    Check3 -->|通过| Step4[Phase 4: Implement]
    Check3 -->|不通过| Step3
    
    Step4 --> S4_1[Cursor生成Handler]
    S4_1 --> S4_2[Cursor生成Logic]
    S4_2 --> S4_3[Cursor生成测试]
    S4_3 --> S4_4[运行测试]
    S4_4 --> Check4{Gate 4}
    Check4 -->|失败| S4_1
    Check4 -->|通过| S4_5[Code Review]
    S4_5 --> S4_6{Review通过?}
    S4_6 -->|否| S4_1
    S4_6 -->|是| End([API完成])
    
    style Step1 fill:#fff3e0
    style Step2 fill:#e8f5e9
    style Step3 fill:#e3f2fd
    style Step4 fill:#f3e5f5
    style End fill:#c8e6c9
```

---

## 📊 数据流转图

### Spec规范如何贯穿整个流程

```mermaid
graph TD
    subgraph "Spec规范库"
        S1[core/]
        S2[architecture/]
        S3[coding-standards/]
        S4[quality/]
    end
    
    subgraph "AI工具"
        T1[Kiro.dev]
        T2[Cursor]
        T3[Claude CLI]
    end
    
    subgraph "开发流程"
        P1[Phase 1: Specify]
        P2[Phase 2: Design]
        P3[Phase 3: Tasks]
        P4[Phase 4: Implement]
    end
    
    subgraph "质量检查"
        Q1[Gate 1]
        Q2[Gate 2]
        Q3[Gate 3]
        Q4[Gate 4]
    end
    
    S1 -.引用.-> T1
    S1 -.引用.-> T2
    S2 -.引用.-> T1
    S2 -.引用.-> T2
    S3 -.引用.-> T2
    S3 -.引用.-> T3
    S4 -.引用.-> T3
    
    T1 --> P1
    T1 --> P2
    T1 --> P3
    T2 --> P4
    T3 --> Q4
    
    P1 --> Q1
    P2 --> Q2
    P3 --> Q3
    P4 --> Q4
    
    Q1 -.遵循.-> S1
    Q2 -.遵循.-> S2
    Q3 -.遵循.-> S2
    Q4 -.遵循.-> S3
    Q4 -.遵循.-> S4
    
    style S1 fill:#e3f2fd
    style T1 fill:#e8f5e9
    style P1 fill:#fff3e0
    style Q1 fill:#ffebee
```

---

## 📖 使用说明

### 如何阅读这些图表

1. **整体架构图** - 了解AI编程体系全貌
2. **5阶段流程图** - 理解完整开发流程
3. **分层架构图** - 掌握代码组织方式
4. **工具协作图** - 选择合适的工具组合
5. **质量门禁图** - 明确每个检查点
6. **场景流程图** - 快速上手实际开发

### 图表在文档中的应用

所有图表都可以嵌入到相关文档中：
- 整体架构图 → 核心理念
- 工作流程图 → 5阶段概览
- 分层架构图 → 规范体系
- 工具协作图 → 工具组合
- 质量门禁图 → 质量门禁
- 场景流程图 → 各个场景文档

---

**图表让理解更直观！** 📊
