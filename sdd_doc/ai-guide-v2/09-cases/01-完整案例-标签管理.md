# 实战案例：从需求到上线

> 完整案例演示5阶段工作流

---

## 📋 案例概述

**功能**：添加数据标签（Tag）管理  
**复杂度**：中等（约400行）  
**工具**：Kiro.dev + Cursor  
**耗时**：1个工作日

---

## 🎯 需求背景

数据管理员希望为数据资源打标签，便于分类和检索。

**核心需求**：
- 创建/删除标签
- 为资源打标签
- 按标签查询资源
- 标签统计

---

## 📝 Phase 0: Context (15分钟)

### Step 1: 阅读规范

```
已阅读：
✅ project-charter.md
✅ workflow.md
✅ layered-architecture.md
✅ go-style-guide.md
```

### Step 2: 环境检查

```bash
# 代码最新
git pull origin main

# 编译通过
go build ./...
✅ Success

# 数据库运行
docker ps | grep mysql
✅ Running
```

### Step 3: 创建分支

```bash
git checkout -b feature/tag-management
```

---

## 📋 Phase 1: Specify (30分钟)

### 使用Kiro.dev

**创建Spec**：
```
Kiro → New Spec
名称：Tag Management
```

**描述功能**：
```
我要添加数据标签管理功能

功能包括：
1. CRUD标签
2. 为资源（数据目录）打标签
3. 按标签查询资源
4. 标签使用统计

约束：
- 标签名称唯一
- 一个资源可以有多个标签
- 遵循IDRM规范
```

### Kiro生成Requirements

```markdown
# Requirements: Tag Management

## User Stories

### Story 1: 创建标签
AS a 数据管理员
I WANT 创建新标签
SO THAT 我可以为数据资源分类

### Story 2: 打标签
AS a 数据管理员  
I WANT 为数据资源打标签
SO THAT 我可以快速组织和查找数据

### Story 3: 按标签查询
AS a 数据使用者
I WANT 按标签查询数据资源
SO THAT 我可以快速找到相关数据

## Acceptance Criteria (EARS)

### 创建标签
WHEN 用户创建标签时提交有效的标签名称和颜色
THE SYSTEM SHALL 保存标签并返回201状态码和标签ID

WHEN 用户提交的标签名称为空
THE SYSTEM SHALL 返回400错误和"标签名称不能为空"

WHEN 用户提交的标签名称已存在
THE SYSTEM SHALL 返回409错误和"标签名称已存在"

WHEN 用户提交的标签名称超过50字符
THE SYSTEM SHALL 返回400错误和"标签名称不能超过50字符"

### 打标签
WHEN 用户为资源添加标签
THE SYSTEM SHALL 建立资源与标签的关联并返回成功状态

WHEN 用户为不存在的资源打标签
THE SYSTEM SHALL 返回404错误和"资源不存在"

WHEN 用户为资源添加不存在的标签
THE SYSTEM SHALL 返回404错误和"标签不存在"

WHEN 用户为资源重复添加同一标签
THE SYSTEM SHALL 返回409错误和"标签已关联"

### 查询
WHEN 用户按标签查询资源
THE SYSTEM SHALL 返回所有包含该标签的资源列表

WHEN 用户查询不存在的标签
THE SYSTEM SHALL 返回404错误和"标签不存在"

### 删除
WHEN 用户删除标签
THE SYSTEM SHALL 同时删除所有该标签的资源关联

## Business Rules

### 标签规则
- 标签名称在系统内必须唯一
- 标签名称长度：1-50个字符
- 标签可选颜色：用于前端展示
- 一个资源可以有多个标签（多对多关系）
- 一个标签可以关联多个资源

### 删除规则
- 删除标签时自动删除所有资源关联
- 删除资源时自动删除所有标签关联
- 使用物理删除（真删除）

### 统计规则
- 统计每个标签关联的资源数量
- 按资源数量倒序排列

## Data Considerations

需要持久化的数据：
- **标签信息**：名称、颜色、创建时间、更新时间
- **资源-标签关联关系**：资源ID、标签ID、关联时间

数据关系：
- 标签和资源是多对多关系
- 通过中间关联表实现
- 删除标签或资源时需级联删除关联关系
```

### Gate 1检查

- [x] User stories完整
- [x] EARS格式正确
- [x] Business rules明确
- [x] Data considerations清晰
- [x] **没有技术实现细节**

**✅ Pass**

---

## 🎨 Phase 2: Design (40分钟)

### Kiro生成Design

```markdown
# Design: Tag Management

## Architecture

遵循分层架构：
\`\`\`
Handler → Logic → Model
\`\`\`

## Technical Constraints

- **架构**：MUST follow layered architecture
- **函数大小**：Functions MUST be < 50 lines
- **注释**：MUST use Chinese comments
- **测试**：Test coverage MUST be > 80%
- **ORM**：使用GORM（关联查询较多）

## File Structure

### Model层
model/resource_catalog/tag/
├── interface.go
├── types.go
├── gorm_dao.go
└── factory.go

### Logic层
api/internal/logic/resource_catalog/tag/
├── createtaglogic.go
├── deletetaglogic.go
├── assigntaglogic.go
├── querybytaglogic.go
└── tagstatslogic.go

### Handler层
api/internal/handler/resource_catalog/tag/
├── createtaghandler.go
├── deletetaghandler.go
├── assigntaghandler.go
├── querybytaghandler.go
└── tagstatshandler.go

## Interfaces

### Model Interface
\`\`\`go
type Model interface {
    // Tag CRUD
    Insert(ctx context.Context, tag *Tag) error
    FindByID(ctx context.Context, id int64) (*Tag, error)
    List(ctx context.Context, page, size int) ([]*Tag, int64, error)
    Delete(ctx context.Context, id int64) error
    FindByName(ctx context.Context, name string) (*Tag, error)
    
    // Resource-Tag association
    AssignTag(ctx context.Context, resourceID, tagID int64) error
    RemoveTag(ctx context.Context, resourceID, tagID int64) error
    GetResourceTags(ctx context.Context, resourceID int64) ([]*Tag, error)
    GetResourcesByTag(ctx context.Context, tagID int64) ([]int64, error)
    
    // Stats
    GetTagStats(ctx context.Context) ([]*TagStat, error)
}
\`\`\`

## Database Schema

### tags表
\`\`\`sql
CREATE TABLE tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL UNIQUE COMMENT '标签名称',
    color VARCHAR(7) COMMENT '标签颜色',
    created_at DATETIME NOT NULL COMMENT '创建时间',
    updated_at DATETIME NOT NULL COMMENT '更新时间',
    INDEX idx_name (name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='标签表';
\`\`\`

### resource_tags表（关联表）
\`\`\`sql
CREATE TABLE resource_tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    resource_id BIGINT NOT NULL COMMENT '资源ID',
    tag_id BIGINT NOT NULL COMMENT '标签ID',
    created_at DATETIME NOT NULL COMMENT '关联时间',
    UNIQUE KEY uk_resource_tag (resource_id, tag_id),
    INDEX idx_resource (resource_id),
    INDEX idx_tag (tag_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='资源标签关联表';
\`\`\`

## Sequence Diagram: 打标签

\`\`\`mermaid
sequenceDiagram
    Client->>Handler: POST /resources/:id/tags
    Handler->>Logic: AssignTag(resourceID, tagID)
    Logic->>Model: FindByID(resourceID)
    Model-->>Logic: resource
    Logic->>Model: FindByID(tagID)
    Model-->>Logic: tag
    Logic->>Model: AssignTag(resourceID, tagID)
    Model-->>Logic: nil
    Logic-->>Handler: success
    Handler-->>Client: 200 OK
\`\`\`
```

### Gate 2检查

- [x] 符合分层架构
- [x] 文件清单完整
- [x] 接口定义清晰
- [x] 序列图完整

**✅ Pass**

---

## 📋 Phase 3: Tasks（20分钟）

### Kiro生成Tasks

```markdown
# Tasks: Tag Management

总计：12个tasks
预估行数：~400行
预估时间：6-8小时

## Task 1: 创建Tag Model接口
Lines: 40
Files: interface.go, types.go
Status: ⏸️

## Task 2: 实现Tag GORM DAO
Lines: 80
Depends: Task 1
Files: gorm_dao.go
Status: ⏸️

## Task 3: 实现Factory
Lines: 30
Depends: Task 2
Files: factory.go
Status: ⏸️

## Task 4-8: Logic层（每个35-40行）
Depends: Task 3

## Task 9-11: Handler层（每个30行）
Depends: Task 4-8

## Task 12: 单元测试
Lines: 120
Depends: All
```

### Gate 3检查

- [x] 每个task <80行
- [x] 依赖清晰
- [x] 验收标准明确

**✅ Pass**

---

## 💻 Phase 4: Implement (4-6小时)

### Task 1-3: Model层（1.5小时）

**使用Cursor**：
```
@tasks.md
@spec/architecture/dual-orm-pattern.md

执行Task 1: 创建Tag Model接口

要求：
- 完整的Model接口
- Tag和ResourceTag结构体
- 错误定义
- 中文注释
```

**生成结果**：
- interface.go ✅
- types.go ✅
- errors.go ✅

**执行Task 2**：
```
@tasks.md  
@model/resource_catalog/tag/interface.go

执行Task 2: 实现GORM DAO

要求：
- 实现所有Model接口方法
- 使用GORM
- 事务处理
- 中文注释
```

**生成结果**：
- gorm_dao.go ✅

**测试**：
```bash
go test ./model/resource_catalog/tag/
PASS
coverage: 88.5%
```

**Commit**：
```bash
git add model/resource_catalog/tag/
git commit -m "feat: add tag model interface and gorm implementation"
```

---

### Task 4-8: Logic层（2小时）

**逐个执行**：
```
Task 4: createtaglogic.go
Task 5: assigntaglogic.go
Task 6: querybytaglogic.go
...
```

**Cursor Prompt模板**：
```
@tasks.md
@model/resource_catalog/tag/interface.go
@spec/coding-standards/go-style-guide.md

执行Task {N}: {任务名}

要求：
- 调用Model接口
- 完整业务逻辑
- 错误处理
- <50行
- 中文注释
```

**测试**：
```bash
go test ./api/internal/logic/resource_catalog/tag/
PASS
coverage: 85.2%
```

---

### Task 9-11: Handler层（1.5小时）

**Cursor生成Handler**：
```
@tasks.md
@logic/resource_catalog/tag/*.go
@spec/architecture/api-design-guide.md

执行Task {N}: {Handler名}

要求：
- 参数绑定验证
- 调用Logic
- 统一响应格式
- 中文注释
```

**API测试**：
```bash
# 启动服务
go run api/api.go

# 测试创建标签
curl -X POST http://localhost:8888/api/v1/tags \
  -d '{"name":"重要数据","color":"#FF0000"}'

# 测试打标签
curl -X POST http://localhost:8888/api/v1/resources/1/tags \
  -d '{"tag_id":1}'

# 测试查询
curl http://localhost:8888/api/v1/tags/1/resources
```

---

### Task 12: 测试（1小时）

**补充测试**：
```
@logic/createtaglogic.go
@spec/coding-standards/testing-standards.md

为这个Logic生成完整的单元测试
要求：
- 表驱动测试
- Mock Model
- 覆盖所有分支
```

**覆盖率检查**：
```bash
go test -cover ./...
model/resource_catalog/tag  coverage: 88.5%
logic/resource_catalog/tag  coverage: 85.2%
handler/resource_catalog/tag coverage: 82.1%

总体覆盖率: 85.3% ✅
```

---

## ✅ Gate 4: 质量检查

### 自动化检查

```bash
# 编译
go build ./...
✅ Success

# 测试
go test ./...
✅ All Pass

# 覆盖率
go test -cover ./...
✅ 85.3% > 80%

# Lint
golangci-lint run
✅ No issues
```

### Code Review

**Self Review**：
- [x] 架构合规
- [x] 函数<50行
- [x] 中文注释
- [x] 错误处理

**创建PR**：
```bash
git push origin feature/tag-management
```

**PR描述**：
```markdown
## 功能：数据标签管理

### 变更
- Model: Tag的GORM实现
- Logic: 标签CRUD和关联逻辑  
- Handler: 5个REST API
- 测试: 85.3%覆盖率

### API
- POST /api/v1/tags
- DELETE /api/v1/tags/:id
- POST /api/v1/resources/:id/tags
- GET /api/v1/tags/:id/resources
- GET /api/v1/tags/stats

### 测试
✅ 编译通过
✅ 测试通过
✅ Lint通过
✅ 覆盖率85.3%
```

**Peer Review → Approved**

**合并代码**：
```bash
git checkout main
git merge feature/tag-management
git push origin main
```

---

## 📊 总结

### 时间消耗

| Phase | 预计 | 实际 | 偏差 |
|-------|------|------|------|
| Phase 0 | 15min | 15min | 0 |
| Phase 1 | 30min | 30min | 0 |
| Phase 2 | 40min | 40min | 0 |
| Phase 3 | 20min | 20min | 0 |
| Phase 4 | 6h | 5.5h | -30min |
| **总计** | **7.5h** | **7h** | **-30min** |

### 代码统计

- 总行数：398行
- Model: 150行
- Logic: 180行
- Handler: 150行
- 测试: 220行
- 覆盖率：85.3%

### 经验教训

**✅ 做得好的**：
1. Kiro规划清晰，节省时间
2. 分阶段执行，每步验证
3. AI辅助效率高
4. 测试覆盖充分

**⚠️ 可改进的**：
1. 初期对需求理解不够深
2. 有些测试用例遗漏
3. Handler层可以更早测试

**💡 建议**：
1. Phase 1多花时间，后面更顺
2. 边实现边测试
3. 充分利用AI但要Review

---

**完整案例演示完毕！** 🎉
