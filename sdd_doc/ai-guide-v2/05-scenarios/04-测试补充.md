# 场景4：批量生成测试

> AI加速测试覆盖

---

## 📋 场景

**需求**：为model层生成单元测试  
**工具**：Claude CLI  
**时间**：15-30分钟

---

## 🧪 批量生成流程

### Step 1: 分析现有代码（5分钟）

```bash
# 查看model文件
ls -la model/resource_catalog/category/

# 检查当前覆盖率
go test -cover ./model/resource_catalog/category/
```

---

### Step 2: 生成测试（10分钟）

#### 方式1：单个文件

```bash
claude --files "sdd_doc/spec/coding-standards/testing-standards.md" \
       --files "model/resource_catalog/category/gorm_dao.go" \
       "为这个文件生成单元测试

要求：
1. 表驱动测试
2. 覆盖所有公开方法
3. Mock外部依赖
4. 中文注释

输出完整的_test.go文件"
```

#### 方式2：批量生成

```bash
# 创建辅助脚本
cat > scripts/generate-tests.sh << 'EOF'
#!/bin/bash

for file in model/**/*_dao.go model/**/*_model.go; do
    if [ ! -f "${file%.*}_test.go" ]; then
        echo "Generating test for $file..."
        claude --files "sdd_doc/spec/coding-standards/testing-standards.md" \
               --files "$file" \
               "生成单元测试" > "${file%.*}_test.go"
    fi
done
EOF

chmod +x scripts/generate-tests.sh
./scripts/generate-tests.sh
```

---

### Step 3: Review测试代码（5分钟）

```bash
# 查看生成的测试
cat model/resource_catalog/category/gorm_dao_test.go

# 重点检查：
# 1. 测试用例是否完整
# 2. Mock是否正确
# 3. 断言是否合理
```

---

### Step 4: 运行测试（5分钟）

```bash
# 运行新生成的测试
go test -v ./model/resource_catalog/category/

# 检查覆盖率
go test -cover ./model/resource_catalog/category/

# 生成覆盖率报告
go test -coverprofile=coverage.out ./model/resource_catalog/category/
go tool cover -html=coverage.out -o coverage.html
```

---

## 📊 测试模板示例

Claude生成的测试通常包含：

```go
package category

import (
    "context"
    "testing"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
)

// TestInsert 测试插入功能
func TestInsert(t *testing.T) {
    tests := []struct {
        name    string
        input   *Category
        wantErr bool
    }{
        {
            name: "正常插入",
            input: &Category{
                Name: "测试分类",
                Code: "test",
            },
            wantErr: false,
        },
        {
            name: "名称为空",
            input: &Category{
                Code: "test",
            },
            wantErr: true,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // Setup
            dao := NewGormDao(mockDB)
            
            // Execute
            err := dao.Insert(context.Background(), tt.input)
            
            // Assert
            if tt.wantErr {
                assert.Error(t, err)
            } else {
                assert.NoError(t, err)
            }
        })
    }
}
```

---

## ✅ 测试质量检查

### MUST Have
- [ ] 所有公开方法都有测试
- [ ] 覆盖率 >80%
- [ ] 正常场景覆盖
- [ ] 异常场景覆盖

### SHOULD Have
- [ ] 边界值测试
- [ ] 并发测试（如适用）
- [ ] 性能测试（如适用）

---

## 🔧 常见问题

### Q1: AI生成的测试不完整？
**A**: 提供更详细的prompt，明确要求覆盖场景

### Q2: Mock不正确？
**A**: 指定使用的Mock框架：testify/mock 或 gomock

### Q3: 覆盖率还是不够？
**A**: 手动补充边界case

---

**批量生成，快速覆盖！** 🧪
