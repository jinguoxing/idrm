# 场景3：代码重构

> AI辅助安全重构

---

## 📋 场景

**需求**：重构model层，统一接口  
**工具**：Cursor  
**时间**：30-60分钟

---

## 🔄 重构流程

### Step 1: 分析现有代码（10分钟）

Cursor Chat:
```
@model/resource_catalog/category/

分析这个model的结构，找出：
1. 不符合规范的地方
2. 可以改进的地方
3. 重构建议

参考规范：
@sdd_doc/spec/architecture/dual-orm-pattern.md
```

Cursor输出分析报告。

---

### Step 2: 制定重构计划（10分钟）

```
基于分析结果，制定重构计划

要求：
1. 分步骤执行
2. 每步都可验证
3. 不破坏现有功能

输出重构步骤清单
```

示例输出：
```markdown
## 重构计划

### Step 1: 统一接口定义
- 创建interface.go
- 定义标准Model接口

### Step 2: 重构GORM实现
- 实现Model接口
- 保持原有功能

### Step 3: 重构SQLx实现
- 实现Model接口
- 保持原有功能

### Step 4: 更新Factory
- 返回接口类型
- 支持配置切换

### Step 5: 验证测试
- 运行现有测试
- 补充缺失测试
```

---

### Step 3: 逐步重构（20-30分钟）

#### 3.1 创建接口

```
执行Step 1：创建interface.go

基于现有代码，定义统一接口：
@model/resource_catalog/category/gorm_dao.go
@model/resource_catalog/category/sqlx_model.go
```

#### 3.2 重构实现

```
执行Step 2：重构GORM实现

修改gorm_dao.go实现Model接口
保持方法签名不变
```

每一步都：
1. 应用代码
2. 编译检查：`go build ./...`
3. 运行测试：`go test ./model/resource_catalog/category/`

---

### Step 4: 验证（10分钟）

```bash
# 完整编译
go build ./...

# 完整测试
go test ./...

# Lint检查
golangci-lint run

# 功能测试
# 启动服务，测试API
```

---

## ⚠️ 重构注意事项

### DO ✅

1. **小步快跑**
   - 每次改动小
   - 频繁测试

2. **保持测试通过**
   - 先有测试
   - 重构不改功能

3. **使用版本控制**
   ```bash
   git checkout -b refactor/model-interface
   git commit -m "refactor: 每一步都commit"
   ```

### DON'T ❌

1. ❌ 大规模修改
2. ❌ 跳过测试
3. ❌ 没有备份

---

## 📝 重构检查清单

- [ ] 功能保持不变
- [ ] 测试全部通过
- [ ] 编译无错误
- [ ] Lint无警告
- [ ] Code Review通过
- [ ] 文档已更新

---

**安全重构，小步前进！** 🔧
